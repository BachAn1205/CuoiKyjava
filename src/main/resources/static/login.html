<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập hệ thống</title>
</head>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background-color: #fff;
    }

    header, footer {
        border: 1px solid #eee;
        padding: 1rem 0;
    }

    header nav a {
        text-decoration: none;
        color: #000;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .login-title {
        text-align: center;
        font-weight: bold;
        font-size: 1.5rem;
        margin-bottom: 2.5rem;
    }

    form {
        max-width: 700px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        /* ... giữ nguyên các style khác ... */
    }
</style>
<body>
<header>
    <div class="container">
        <nav>
            <a href="index.html">Trang chính</a> |
            <a href="register.html">Đăng ký</a>
        </nav>
    </div>
</header>

<div class="container">
    <h1 class="login-title">Đăng nhập hệ thống quản lý thiết bị</h1>
    <form onsubmit="login(event)">
        <div class="form-row">
            <div style="flex:1;">
                <label for="username">Tên đăng nhập:</label>
                <input type="text" id="username" name="username" placeholder="Nhập tên đăng nhập" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;" />
            </div>
            <div style="flex:1;">
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" name="password" placeholder="Nhập mật khẩu" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;" />
            </div>
        </div>
        <button type="submit" style="padding:0.75rem 1.5rem; background-color:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Đăng nhập</button>
    </form>
</div>

<footer>
    <div class="container">
        <div style="font-weight:600;">Navigation</div>
        <ul style="list-style:none;padding:0;margin:0;line-height:1.8;color:#6b7280;">
            <li><a href="index.html">Trang chính</a></li>
            <li><a href="register.html">Đăng ký</a></li>
            <li><a href="login.html">Đăng nhập</a></li>
        </ul>
    </div>
</footer>

<script>
    async function login(event) {
        event.preventDefault(); // Ngăn chặn hành vi submit mặc định của form

        const username = document.getElementById('username');
        const password = document.getElementById('password');

        if (!username.value || !password.value) {
            alert('Vui lòng điền đầy đủ tên đăng nhập và mật khẩu.');
            return;
        }

        try {
            const res = await fetch("/api/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: username.value,
                    password: password.value
                })
            });

            if (res.ok) {
                const data = await res.json();
                console.log("Response data:", data); // Log toàn bộ data để kiểm tra cấu trúc

                // Kiểm tra và hiển thị message
                if (data.message) {
                    alert(data.message);
                }

                // LƯU Ý: Backend trả về cấu trúc { message: "...", user: { ... } }
                // Nên bạn cần truy cập data.user.role và data.user.fullName
                localStorage.setItem("userRole", data.user.role);
                localStorage.setItem("userName", data.user.fullName || data.user.username); // Dùng data.user.username nếu fullName null

                switch (data.user.role) {
                    case "Admin":
                        window.location.href = "dashboard-admin.html";
                        break;
                    case "Nhân viên thiết bị":
                        window.location.href = "dashboard-nhanvien.html";
                        break;
                    case "Kỹ thuật viên":
                        window.location.href = "dashboard-kythuatvien.html";
                        break;
                    case "Sinh viên":
                        window.location.href = "dashboard-sinhvien.html";
                        break;
                    case "Giảng viên":
                        window.location.href = "dashboard-giangvien.html";
                        break;
                    default:
                        alert("Vai trò không hợp lệ được trả về từ máy chủ!");
                }
            } else {
                const errText = await res.text();
                alert("Đăng nhập thất bại: " + errText);
            }
        } catch (error) {
            console.error('Lỗi khi đăng nhập (Network hoặc JS error):', error);
            alert('Đã xảy ra lỗi trong quá trình đăng nhập. Vui lòng thử lại.');
        }
    }
</script>

</body>
</html>